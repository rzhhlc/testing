<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Almost Sudoku</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --cell-size: 44px; /* Approx 4x4 inches total on screen */
            --border-thin: 1.0pt solid black;
            --border-thick: 2.5pt solid black;
            --border-outer: 3.0pt solid black;
        }

        body {
            background-color: white;
            color: black;
            font-family: sans-serif;
        }

        /* Screen sizing: 9 cells * 44px ~ 396px (~4 inches) */
        .sudoku-grid {
            display: grid;
            grid-template-columns: repeat(9, var(--cell-size));
            grid-template-rows: repeat(9, var(--cell-size));
            border-top: var(--border-outer);
            border-left: var(--border-outer);
            width: fit-content;
            margin: 0 auto;
            background-color: white;
            gap: 0;
            box-sizing: content-box;
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: bold;
            border-right: var(--border-thin);
            border-bottom: var(--border-thin);
            box-sizing: border-box;
        }

        .cell:nth-child(3n) { border-right: var(--border-thick); }
        .cell:nth-child(9n) { border-right: var(--border-outer); }

        .cell:nth-child(n+19):nth-child(-n+27),
        .cell:nth-child(n+46):nth-child(-n+54) {
            border-bottom: var(--border-thick);
        }
        .cell:nth-child(n+73):nth-child(-n+81) {
            border-bottom: var(--border-outer);
        }

        #print-id-label {
            display: none;
        }

        /* Print Settings: 6x6 inches */
        @media print {
            @page { size: auto; margin: 0.5in; }
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 6in !important;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            #print-id-label {
                display: block;
                font-size: 18pt;
                font-weight: bold;
                margin-bottom: 0.25in;
                text-align: center;
                width: 100%;
            }
            .sudoku-grid {
                width: 6in !important;
                height: 6in !important;
                grid-template-columns: repeat(9, 0.666in);
                grid-template-rows: repeat(9, 0.666in);
            }
            .cell {
                width: 0.666in !important;
                height: 0.666in !important;
                font-size: 28pt !important;
            }
            .no-print { display: none !important; }
        }

        .btn {
            border: 2px solid #bfdbfe;
            padding: 8px 16px;
            background: #eff6ff;
            cursor: pointer;
            font-weight: bold;
            border-radius: 0.5rem;
            transition: all 0.2s;
            color: #1e40af;
        }
        .btn:hover { 
            background: #dbeafe;
            border-color: #3b82f6;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            justify-content: center; align-items: center;
            z-index: 50;
        }
    </style>
</head>
<body class="p-4">

    <div class="max-w-xl mx-auto space-y-6 no-print">
        <h1 class="text-3xl font-black text-center border-b-4 border-black pb-2 uppercase">Almost Sudoku</h1>
        
        <div class="flex flex-wrap gap-4 justify-center items-center bg-gray-50 p-4 border-2 border-black rounded-xl">
            <div class="flex flex-col">
                <label class="text-xs font-bold text-gray-500">DIFFICULTY</label>
                <select id="difficulty" class="border-2 border-blue-100 rounded-md p-1 font-bold bg-white">
                    <option value="easy">Easy (45 clues)</option>
                    <option value="medium" selected>Medium (35 clues)</option>
                    <option value="hard">Hard (25 clues)</option>
                </select>
            </div>
            <div class="flex flex-col">
                <label class="text-xs font-bold text-gray-500">PUZZLE ID</label>
                <div class="flex">
                    <input type="text" id="puzzle-id-input" placeholder="Seed" class="border-2 border-blue-100 rounded-l-md p-1 w-24">
                    <button onclick="loadFromId()" class="btn py-1 rounded-l-none border-l-0">Load</button>
                </div>
            </div>
        </div>

        <div class="flex flex-wrap gap-2 justify-center">
            <button onclick="generateNew()" class="btn">New Puzzle</button>
            <button onclick="toggleSolution()" class="btn" id="solution-btn">Show Solution</button>
            <button onclick="window.print()" class="btn">Print Puzzle</button>
        </div>

        <div class="text-center">
            <span class="font-mono text-lg bg-black text-white px-4 py-1 rounded-full" id="display-id">ID: -----</span>
        </div>
    </div>

    <!-- Main Display Area -->
    <div id="printable-area" class="mt-8 flex flex-col items-center">
        <div id="print-id-label">ID: -----</div>
        <div id="grid-container" class="sudoku-grid">
            <!-- Cells injected via JS -->
        </div>
    </div>

    <div id="msg-modal" class="modal" onclick="closeModal()">
        <div class="bg-white p-8 border-4 border-black rounded-2xl max-w-sm text-center" onclick="event.stopPropagation()">
            <p id="msg-text" class="text-xl font-bold mb-4"></p>
            <button onclick="closeModal()" class="btn">Dismiss</button>
        </div>
    </div>

    <script>
        let currentFullGrid = [];
        let currentPuzzleGrid = [];
        let showingSolution = false;

        window.onload = () => {
            generateNew();
        };

        function showMessage(text) {
            document.getElementById('msg-text').innerText = text;
            document.getElementById('msg-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('msg-modal').style.display = 'none';
        }

        function generateBaseGrid() {
            let grid = Array.from({ length: 9 }, () => Array(9).fill(0));
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    grid[r][c] = ((r * 3 + Math.floor(r / 3) + c) % 9) + 1;
                }
            }
            return grid;
        }

        function seededRandom(seed) {
            const x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
        }

        function shuffle(array, seed) {
            let m = array.length, t, i;
            let s = seed;
            while (m) {
                i = Math.floor(seededRandom(s++) * m--);
                t = array[m];
                array[m] = array[i];
                array[i] = t;
            }
            return array;
        }

        function applyPermutations(grid, seed) {
            let newGrid = JSON.parse(JSON.stringify(grid));
            let s = seed;

            let digits = shuffle([1, 2, 3, 4, 5, 6, 7, 8, 9], s++);
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    newGrid[r][c] = digits[newGrid[r][c] - 1];
                }
            }

            for (let band = 0; band < 3; band++) {
                let rowIndices = [0, 1, 2].map(x => x + band * 3);
                shuffle(rowIndices, s++);
                let originalRows = rowIndices.map(r => [...newGrid[r]]);
                [0, 1, 2].forEach(i => {
                    newGrid[band * 3 + i] = originalRows[i];
                });
            }

            for (let stack = 0; stack < 3; stack++) {
                let colIndices = [0, 1, 2].map(x => x + stack * 3);
                shuffle(colIndices, s++);
                let originalCols = [];
                for (let r = 0; r < 9; r++) {
                    originalCols[r] = colIndices.map(c => newGrid[r][c]);
                }
                for (let r = 0; r < 9; r++) {
                    colIndices.forEach((cIdx, i) => {
                        newGrid[r][stack * 3 + i] = originalCols[r][i];
                    });
                }
            }

            return newGrid;
        }

        function validateRestrictions(grid) {
            for (let c = 0; c < 8; c++) {
                for (let r = 0; r < 9; r++) {
                    let a = grid[r][c], b = grid[r][c+1];
                    for (let r2 = 0; r2 < 9; r2++) {
                        if (r === r2) continue;
                        if (grid[r2][c] === b && grid[r2][c+1] === a) return false;
                    }
                }
            }

            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 9; c++) {
                    let a = grid[r][c], b = grid[r+1][c];
                    for (let c2 = 0; c2 < 9; c2++) {
                        if (c === c2) continue;
                        if (grid[r][c2] === b && grid[r+1][c2] === a) return false;
                    }
                }
            }

            function get2x2Set(r, c) {
                return [grid[r][c], grid[r][c+1], grid[r+1][c], grid[r+1][c+1]].sort().join(',');
            }

            for (let c = 0; c < 8; c++) {
                for (let r = 0; r < 8; r++) {
                    let set1 = get2x2Set(r, c);
                    for (let r2 = 0; r2 < 8; r2++) {
                        if (r === r2) continue;
                        if (get2x2Set(r2, c) === set1) return false;
                    }
                }
            }

            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    let set1 = get2x2Set(r, c);
                    for (let c2 = 0; c2 < 8; c2++) {
                        if (c === c2) continue;
                        if (get2x2Set(r, c2) === set1) return false;
                    }
                }
            }

            return true;
        }

        function createPuzzle(fullGrid, difficulty, seed) {
            let cluesCount = difficulty === 'easy' ? 45 : (difficulty === 'medium' ? 35 : 25);
            let puzzle = JSON.parse(JSON.stringify(fullGrid));
            let cells = Array.from({length: 81}, (_, i) => i);
            
            shuffle(cells, seed + 500);
            let toRemove = 81 - cluesCount;
            for (let i = 0; i < toRemove; i++) {
                let idx = cells[i];
                puzzle[Math.floor(idx / 9)][idx % 9] = 0;
            }
            return puzzle;
        }

        function renderGrid() {
            const container = document.getElementById('grid-container');
            container.innerHTML = '';
            const data = showingSolution ? currentFullGrid : currentPuzzleGrid;

            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    const val = data[r][c];
                    cell.innerText = val === 0 ? '' : val;
                    
                    if (showingSolution && currentPuzzleGrid[r][c] === 0) {
                        cell.style.color = "#666"; 
                    } else {
                        cell.style.color = "black";
                    }

                    container.appendChild(cell);
                }
            }
        }

        function generateNew() {
            const id = Math.floor(Math.random() * 900000) + 100000;
            const diff = document.getElementById('difficulty').value;
            document.getElementById('puzzle-id-input').value = id;
            loadPuzzle(id, diff);
        }

        function loadFromId() {
            const idStr = document.getElementById('puzzle-id-input').value;
            const id = parseInt(idStr);
            if (isNaN(id)) {
                showMessage("Invalid ID. Please enter numbers only.");
                return;
            }
            const diffs = ['easy', 'medium', 'hard'];
            const diff = diffs[id % 3];
            document.getElementById('difficulty').value = diff;
            loadPuzzle(id, diff);
        }

        function loadPuzzle(id, diff) {
            showingSolution = false;
            document.getElementById('solution-btn').innerText = "Show Solution";
            document.getElementById('display-id').innerText = `ID: ${id}`;
            document.getElementById('print-id-label').innerText = `ID: ${id}`;
            
            let base = generateBaseGrid();
            let finalGrid = null;
            let attempt = 0;
            
            while (!finalGrid && attempt < 200) {
                let candidate = applyPermutations(base, id + (attempt * 77));
                if (validateRestrictions(candidate)) {
                    finalGrid = candidate;
                }
                attempt++;
            }

            currentFullGrid = finalGrid || applyPermutations(base, id);
            currentPuzzleGrid = createPuzzle(currentFullGrid, diff, id);
            renderGrid();
        }

        function toggleSolution() {
            showingSolution = !showingSolution;
            document.getElementById('solution-btn').innerText = showingSolution ? "Hide Solution" : "Show Solution";
            renderGrid();
        }
    </script>
</body>
</html>