<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setting the Table</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --puzzle-dim-screen: 4in;
            --puzzle-dim-print: 5in;
            --sum-size: 48px; 
            --gap: 12px;      
        }

        body {
            background-color: #f8fafc;
            font-family: system-ui, -apple-system, sans-serif;
        }

        .puzzle-wrapper {
            width: var(--puzzle-dim-screen);
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .puzzle-assembly {
            display: grid;
            width: 100%;
            grid-template-columns: 1fr var(--gap) var(--sum-size);
            grid-template-rows: 1fr var(--gap) var(--sum-size);
        }

        .table-proper {
            grid-column: 1;
            grid-row: 1;
            display: grid;
            background-color: white;
            border: 2pt solid black; 
            aspect-ratio: 1 / 1;    
        }

        .cell {
            border: 1pt solid black; 
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .cell input {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            font-size: 1.25rem;
            outline: none;
            background: transparent;
            appearance: textfield;
        }

        .cell input::-webkit-outer-spin-button,
        .cell input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .pre-filled {
            background-color: #f1f5f9;
            font-weight: bold;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .row-sums-container {
            grid-column: 3;
            grid-row: 1;
            display: grid;
            gap: 4px;
        }

        .col-sums-container {
            grid-column: 1;
            grid-row: 3;
            display: grid;
            gap: 4px;
        }

        .sum-box {
            border: 1pt solid black;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
            border-radius: 8px;
        }

        .id-display {
            font-family: monospace;
            font-size: 0.9rem;
            color: #475569;
            margin-top: 1.5rem;
            text-align: center;
        }

        /* Example View Styling */
        #exampleView {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem;
        }

        .example-grid {
            display: grid;
            grid-template-columns: repeat(3, 60px) 15px 50px;
            grid-template-rows: repeat(3, 60px) 15px 50px;
            gap: 4px;
            margin: 1.5rem 0;
            font-family: sans-serif;
        }

        .eg-cell { border: 1px solid black; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; background: white; }
        .eg-pre { background: #f1f5f9; }
        .eg-sum { border: 1px solid black; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; background: white; }
        .eg-val-red { color: #ef4444; }
        .eg-val-purple { color: #a855f7; }

        @media print {
            @page { margin: 0.5in; }
            body { background: white !important; padding: 0; }
            .no-print { display: none !important; }
            .puzzle-wrapper {
                width: var(--puzzle-dim-print) !important;
                margin-top: 20px;
            }
            .id-display { color: black; }
            header { display: block !important; margin-bottom: 20px; }
            h1 { color: black !important; }
            p { color: #333 !important; }
            #exampleView { display: none !important; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Main Game View -->
    <div id="mainView" class="max-w-3xl mx-auto space-y-6">
        <header class="text-center">
            <h1 class="text-3xl font-bold text-gray-900">Setting the Table</h1>
            <p id="subheading" class="text-gray-600 mt-1">Fill the grid with the consecutive numbers from 1 to 9</p>
            <p class="text-gray-600">The sums of the rows and columns are shown.</p>
        </header>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 space-y-4 no-print">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Rows (x ≥ 2)</label>
                    <input type="number" id="gridSize" min="2" max="10" value="3" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 !h-auto">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Puzzle ID</label>
                    <input type="text" id="puzzleIdInput" placeholder="Enter ID to regenerate" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 !h-auto">
                </div>
            </div>
            
            <div class="flex flex-wrap gap-2 pt-2">
                <button onclick="createNewPuzzle()" class="bg-blue-600 text-white px-5 py-2 rounded-md font-medium hover:bg-blue-700 transition">New Puzzle</button>
                <button onclick="showSolution()" class="bg-slate-100 text-slate-700 px-5 py-2 rounded-md font-medium hover:bg-slate-200 transition">Show Solution</button>
                <button onclick="window.print()" class="bg-gray-800 text-white px-5 py-2 rounded-md font-medium hover:bg-gray-900 transition">Print Puzzle</button>
                <button onclick="toggleExample(true)" class="bg-teal-600 text-white px-5 py-2 rounded-md font-medium hover:bg-teal-700 transition">Example</button>
            </div>
        </div>

        <div class="puzzle-wrapper">
            <div id="puzzleAssembly" class="puzzle-assembly"></div>
            <div id="idLabel" class="id-display">ID: </div>
        </div>
    </div>

    <!-- Example View -->
    <div id="exampleView">
        <button onclick="toggleExample(false)" class="fixed top-6 right-6 bg-gray-100 text-gray-800 px-4 py-2 rounded-md font-bold hover:bg-gray-200 shadow-sm border border-gray-300">Return to puzzle</button>
        
        <div class="max-w-2xl mx-auto space-y-8 pb-12">
            <h1 class="text-3xl font-bold border-b pb-4">settable example</h1>
            
            <div class="space-y-4">
                <p>We have the numbers 1 2 3 4 5 6 7 8 9 to work with. 21 = 7 + &nbsp;&nbsp; + &nbsp;&nbsp; . So we need two numbers that sum to 14; candidates are: 5 + 9 and 6 + 8. We’ll just guess and hope for the best.</p>
                
                <div class="example-grid">
                    <!-- Row 1 -->
                    <div class="eg-cell"></div><div class="eg-cell eg-pre">7</div><div class="eg-cell"></div><div></div><div class="eg-sum">18</div>
                    <!-- Row 2 -->
                    <div class="eg-cell"></div><div class="eg-cell eg-pre">6</div><div class="eg-cell"></div><div></div><div class="eg-sum">13</div>
                    <!-- Row 3 -->
                    <div class="eg-cell"></div><div class="eg-cell eg-pre">8</div><div class="eg-cell"></div><div></div><div class="eg-sum">14</div>
                    <!-- Gaps -->
                    <div></div><div></div><div></div><div></div><div></div>
                    <!-- Col Sums -->
                    <div class="eg-sum">13</div><div class="eg-sum">21</div><div class="eg-sum">11</div><div></div><div></div>
                </div>

                <p>Since 13 is the smallest row, we’ll try that next: 13 = 6 + &nbsp;&nbsp; + &nbsp;&nbsp; . Candidates are: 2 + 5, 3 + 4. Guess again:</p>

                <div class="example-grid">
                    <div class="eg-cell"></div><div class="eg-cell eg-pre">7</div><div class="eg-cell"></div><div></div><div class="eg-sum">18</div>
                    <div class="eg-cell eg-val-red">4</div><div class="eg-cell eg-pre">6</div><div class="eg-cell eg-val-red">3</div><div></div><div class="eg-sum">13</div>
                    <div class="eg-cell"></div><div class="eg-cell eg-pre">8</div><div class="eg-cell"></div><div></div><div class="eg-sum">14</div>
                    <div></div><div></div><div></div><div></div><div></div>
                    <div class="eg-sum">13</div><div class="eg-sum">21</div><div class="eg-sum">11</div><div></div><div></div>
                </div>

                <p>The only possibility for row 3 is: 14 = 8 + 1 + 5, but this won’t work: if you put 5 in column 3 then: 11 = 5 + 3 + 3 and if you put 1 in column 3 you get: 11 = 1 + 3 + 7. Let’s swap the 3 and 4 in row two and see what happens:</p>

                <div class="example-grid">
                    <div class="eg-cell"></div><div class="eg-cell eg-pre">7</div><div class="eg-cell"></div><div></div><div class="eg-sum">18</div>
                    <div class="eg-cell eg-val-red">3</div><div class="eg-cell eg-pre">6</div><div class="eg-cell eg-val-red">4</div><div></div><div class="eg-sum">13</div>
                    <div class="eg-cell"></div><div class="eg-cell eg-pre">8</div><div class="eg-cell"></div><div></div><div class="eg-sum">14</div>
                    <div></div><div></div><div></div><div></div><div></div>
                    <div class="eg-sum">13</div><div class="eg-sum">21</div><div class="eg-sum">11</div><div></div><div></div>
                </div>

                <p>Now we try column three: 11 = 5 + 4 + 2, which works and then column one: 13 = 1 + 3 + 9, which also works.</p>

                <div class="example-grid">
                    <div class="eg-cell eg-val-purple">9</div><div class="eg-cell eg-pre">7</div><div class="eg-cell eg-val-purple">2</div><div></div><div class="eg-sum">18</div>
                    <div class="eg-cell eg-val-red">3</div><div class="eg-cell eg-pre">6</div><div class="eg-cell eg-val-red">4</div><div></div><div class="eg-sum">13</div>
                    <div class="eg-cell eg-val-purple">1</div><div class="eg-cell eg-pre">8</div><div class="eg-cell eg-val-purple">5</div><div></div><div class="eg-sum">14</div>
                    <div></div><div></div><div></div><div></div><div></div>
                    <div class="eg-sum">13</div><div class="eg-sum">21</div><div class="eg-sum">11</div><div></div><div></div>
                </div>

                <p>Fortunately, the row one sum works out and the puzzle is solved. Our choice and placing of 6 and 8 at the start was lucky indeed! Is there a better strategy .. try to find one.</p>
                <p>Have fun!</p>
            </div>
        </div>
    </div>

    <script>
        let solutionGrid = [];
        let currentPuzzleSeed = "";

        function sfc32(a, b, c, d) {
            a >>>= 0; b >>>= 0; c >>>= 0; d >>>= 0; 
            return function() {
                var t = (a + b | 0) + d | 0;
                d = d + 1 | 0;
                a = b ^ b >>> 9;
                b = c + (c << 3) | 0;
                c = (c << 21 | c >>> 11);
                c = c + t | 0;
                return (t >>> 0) / 4294967296;
            }
        }

        function getSeededRandom(seedStr) {
            let h1 = 1779033703, h2 = 2778083391, h3 = 669920902, h4 = 253473474;
            for (let i = 0, k; i < seedStr.length; i++) {
                k = seedStr.charCodeAt(i);
                h1 = h2 ^ Math.imul(h1 ^ k, 597399067);
                h2 = h3 ^ Math.imul(h2 ^ k, 2869860233);
                h3 = h4 ^ Math.imul(h3 ^ k, 951274213);
                h4 = h1 ^ Math.imul(h4 ^ k, 2716044179);
            }
            return sfc32(h1, h2, h3, h4);
        }

        function generateRandomString() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function toggleExample(show) {
            document.getElementById('exampleView').style.display = show ? 'block' : 'none';
            document.getElementById('mainView').style.display = show ? 'none' : 'block';
            if (!show) window.scrollTo(0,0);
        }

        function createNewPuzzle() {
            const inputField = document.getElementById('puzzleIdInput');
            const inputVal = inputField.value.trim();
            let x = parseInt(document.getElementById('gridSize').value);
            let seed = "";

            if (inputVal) {
                if (inputVal.includes('-')) {
                    const parts = inputVal.split('-');
                    const parsedX = parseInt(parts[0]);
                    if (!isNaN(parsedX) && parsedX >= 2) {
                        x = parsedX;
                        document.getElementById('gridSize').value = x;
                    }
                    seed = parts[1];
                } else {
                    seed = inputVal;
                }
            } else {
                seed = generateRandomString();
            }

            const fullId = `${x}-${seed}`;
            document.getElementById('idLabel').innerText = "ID: " + fullId;
            inputField.value = "";

            const count = x * x;
            document.getElementById('subheading').innerText = `Fill the grid with the consecutive numbers from 1 to ${count}`;

            const rng = getSeededRandom(seed);

            let numbers = Array.from({length: count}, (_, i) => i + 1);
            for (let i = numbers.length - 1; i > 0; i--) {
                const j = Math.floor(rng() * (i + 1));
                [numbers[i], numbers[j]] = [numbers[j], numbers[i]];
            }

            solutionGrid = [];
            for (let i = 0; i < x; i++) {
                solutionGrid.push(numbers.slice(i * x, i * x + x));
            }

            const rowSums = solutionGrid.map(row => row.reduce((a, b) => a + b, 0));
            const colSums = Array(x).fill(0);
            for (let j = 0; j < x; j++) {
                for (let i = 0; i < x; i++) colSums[j] += solutionGrid[i][j];
            }

            let preFillCount = Math.max(0, (x * x) - (2 * x) - 2);
            const cellIndices = [];
            for (let i = 0; i < x; i++) {
                for (let j = 0; j < x; j++) cellIndices.push({r: i, c: j});
            }
            for (let i = cellIndices.length - 1; i > 0; i--) {
                const j = Math.floor(rng() * (i + 1));
                [cellIndices[i], cellIndices[j]] = [cellIndices[j], cellIndices[i]];
            }
            const preFilled = cellIndices.slice(0, preFillCount);

            render(x, rowSums, colSums, preFilled);
        }

        function render(x, rowSums, colSums, preFilled) {
            const assembly = document.getElementById('puzzleAssembly');
            assembly.innerHTML = "";

            const table = document.createElement('div');
            table.className = "table-proper";
            table.style.gridTemplateColumns = `repeat(${x}, 1fr)`;
            table.style.gridTemplateRows = `repeat(${x}, 1fr)`;

            for (let i = 0; i < x; i++) {
                for (let j = 0; j < x; j++) {
                    const cell = document.createElement('div');
                    cell.className = "cell";
                    
                    const isPre = preFilled.some(p => p.r === i && p.c === j);
                    if (isPre) {
                        cell.innerHTML = `<div class="pre-filled">${solutionGrid[i][j]}</div>`;
                    } else {
                        const input = document.createElement('input');
                        input.type = "number";
                        input.dataset.r = i;
                        input.dataset.c = j;
                        cell.appendChild(input);
                    }
                    table.appendChild(cell);
                }
            }
            assembly.appendChild(table);

            const rowContainer = document.createElement('div');
            rowContainer.className = "row-sums-container";
            rowContainer.style.gridTemplateRows = `repeat(${x}, 1fr)`;
            rowSums.forEach(sum => {
                const box = document.createElement('div');
                box.className = "sum-box";
                box.innerText = sum;
                rowContainer.appendChild(box);
            });
            assembly.appendChild(rowContainer);

            const colContainer = document.createElement('div');
            colContainer.className = "col-sums-container";
            colContainer.style.gridTemplateColumns = `repeat(${x}, 1fr)`;
            colSums.forEach(sum => {
                const box = document.createElement('div');
                box.className = "sum-box";
                box.innerText = sum;
                colContainer.appendChild(box);
            });
            assembly.appendChild(colContainer);
        }

        function showSolution() {
            const inputs = document.querySelectorAll('input[data-r]');
            inputs.forEach(input => {
                const r = parseInt(input.dataset.r);
                const c = parseInt(input.dataset.c);
                input.value = solutionGrid[r][c];
                input.style.color = "#2563eb";
                input.style.fontWeight = "bold";
            });
        }

        window.onload = createNewPuzzle;
    </script>
</body>
</html>